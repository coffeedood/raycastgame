<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Raycasting - Grey Walls, Transparent Above</title>
<style>
  body { margin: 0; overflow: hidden; background: black; }
  canvas { display: block; margin: 0 auto; background: transparent; }
</style>
</head>
<body>
<canvas id="canvas"></canvas>
<script>
(() => {
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");

  // Set canvas size
  const WIDTH = canvas.width = 800;
  const HEIGHT = canvas.height = 400;

  // Player and map setup
  const FOV = Math.PI / 3;  // 60 degrees field of view
  const NUM_RAYS = WIDTH;
  const MAX_DEPTH = 20;

  const mapSize = 8;
  const map = [
    [1, 1, 1, 1, 1, 1, 1, 1],
    [1, 0, 0, 0, 0, 0, 0, 1],
    [1, 0, 0.6, 0, 0, 0, 0, 1], // short wall with height 0.6
    [1, 0, 0, 1, 1, 0, 0, 1],
    [1, 0, 0, 1.2, 1.2, 0, 0, 1], // taller walls 1.2 height
    [1, 0, 0, 0, 0, 0, 0, 1],
    [1, 0, 0, 0, 0, 0, 0, 1],
    [1, 1, 1, 1, 1, 1, 1, 1]
  ];

  const player = {
    x: 3.5,
    y: 3.5,
    angle: 0,
    speed: 0.05,
  };

  // Cast a single ray from player in angle `rayAngle`
  // Return object with distance and wall height at hit
  function castRay(rayAngle) {
    let distance = 0;
    const step = 0.01;

    while (distance < MAX_DEPTH) {
      const testX = player.x + Math.cos(rayAngle) * distance;
      const testY = player.y + Math.sin(rayAngle) * distance;

      if (testX < 0 || testX >= mapSize || testY < 0 || testY >= mapSize) {
        return { distance: MAX_DEPTH, height: 0 };
      }

      const mapX = Math.floor(testX);
      const mapY = Math.floor(testY);

      const wallHeight = map[mapY][mapX];
      if (wallHeight > 0) {
        return { distance, height: wallHeight };
      }

      distance += step;
    }

    return { distance: MAX_DEPTH, height: 0 };
  }

  function drawScene() {
    // Clear canvas (transparent background)
    ctx.clearRect(0, 0, WIDTH, HEIGHT);

    // Draw sky (transparent = show through)
    // Here we fill with sky color at top half of canvas
    ctx.fillStyle = "#87CEEB"; // Sky blue
    ctx.fillRect(0, 0, WIDTH, HEIGHT / 2);

    // Draw floor (dark gray)
    ctx.fillStyle = "#333";
    ctx.fillRect(0, HEIGHT / 2, WIDTH, HEIGHT / 2);

    // Cast rays and draw vertical slices
    for (let i = 0; i < NUM_RAYS; i++) {
      // Angle of ray relative to player viewing angle
      const rayScreenPos = (i / NUM_RAYS) - 0.5;  // -0.5 to +0.5
      const rayAngle = player.angle + rayScreenPos * FOV;

      let ray = castRay(rayAngle);

      // Remove fish-eye effect
      let correctedDist = ray.distance * Math.cos(rayAngle - player.angle);

      if (ray.height > 0) {
        // Project wall height on screen
        let projectedHeight = (HEIGHT / correctedDist) * ray.height;

        // Y coordinate where wall starts (top)
        let wallTop = (HEIGHT / 2) - projectedHeight;

        // Draw wall slice as grey rectangle
        ctx.fillStyle = "grey";
        ctx.fillRect(i, wallTop, 1, projectedHeight);

        // **No black shadow or fill below or above the wall**
        // Transparent above = sky visible
        // No black below = floor visible
      }
    }
  }

  function update() {
    // Player controls (left/right turn, forward/back)
    window.addEventListener("keydown", (e) => {
      if (e.key === "ArrowLeft") {
        player.angle -= 0.05;
      } else if (e.key === "ArrowRight") {
        player.angle += 0.05;
      } else if (e.key === "ArrowUp") {
        player.x += Math.cos(player.angle) * player.speed;
        player.y += Math.sin(player.angle) * player.speed;
      } else if (e.key === "ArrowDown") {
        player.x -= Math.cos(player.angle) * player.speed;
        player.y -= Math.sin(player.angle) * player.speed;
      }
    });
  }

  function gameLoop() {
    drawScene();
    requestAnimationFrame(gameLoop);
  }

  update();
  gameLoop();
})();
</script>
</body>
</html>
