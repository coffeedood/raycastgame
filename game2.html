<!DOCTYPE html>
<html>
<head>
  <title>Raycaster with 3D Floor Items</title>
  <style>
    html, body {
      margin: 0; padding: 0; overflow: hidden; background: black;
      height: 100%; width: 100%;
    }
    canvas { display: block; margin: auto; background: #111; }
  </style>
</head>
<body>
<canvas id="game"></canvas>
<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const w = canvas.width = window.innerWidth;
const h = canvas.height = window.innerHeight;

const MAP_SIZE = 24;
const TILE_SIZE = 0.5; // world units per tile
const WALL_HEIGHT = 1.0;

const map = [
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,2,2,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

// Doors map 2
map[10][10] = 2;
map[10][11] = 2;

// Player position
let posX = 12.5;
let posY = 12.5;
let dirX = -1;
let dirY = 0;
let planeX = 0;
let planeY = 0.66;

// Movement
const moveSpeed = 0.05;
const rotSpeed = 0.03;

const keys = {};
window.addEventListener("keydown", e => { keys[e.key] = true; });
window.addEventListener("keyup", e => { keys[e.key] = false; });

// Items â€” positions on map (in world coords)
const items = [
  { x: 13.5, y: 10.5, name: "Gold" },
  { x: 15.2, y: 13.8, name: "Potion" },
  { x: 11.3, y: 14.4, name: "Key" }
];

// Movement logic
function update() {
  if(keys["w"]) {
    const nextX = posX + dirX * moveSpeed;
    const nextY = posY + dirY * moveSpeed;
    if(map[Math.floor(nextX)][Math.floor(posY)] === 0) posX = nextX;
    if(map[Math.floor(posX)][Math.floor(nextY)] === 0) posY = nextY;
  }
  if(keys["s"]) {
    const nextX = posX - dirX * moveSpeed;
    const nextY = posY - dirY * moveSpeed;
    if(map[Math.floor(nextX)][Math.floor(posY)] === 0) posX = nextX;
    if(map[Math.floor(posX)][Math.floor(nextY)] === 0) posY = nextY;
  }
  if(keys["a"]) {
    const oldDirX = dirX;
    dirX = dirX * Math.cos(rotSpeed) - dirY * Math.sin(rotSpeed);
    dirY = oldDirX * Math.sin(rotSpeed) + dirY * Math.cos(rotSpeed);
    const oldPlaneX = planeX;
    planeX = planeX * Math.cos(rotSpeed) - planeY * Math.sin(rotSpeed);
    planeY = oldPlaneX * Math.sin(rotSpeed) + planeY * Math.cos(rotSpeed);
  }
  if(keys["d"]) {
    const oldDirX = dirX;
    dirX = dirX * Math.cos(-rotSpeed) - dirY * Math.sin(-rotSpeed);
    dirY = oldDirX * Math.sin(-rotSpeed) + dirY * Math.cos(-rotSpeed);
    const oldPlaneX = planeX;
    planeX = planeX * Math.cos(-rotSpeed) - planeY * Math.sin(-rotSpeed);
    planeY = oldPlaneX * Math.sin(-rotSpeed) + planeY * Math.cos(-rotSpeed);
  }
}

// Raycasting walls & doors
function castRays() {
  for(let x = 0; x < w; x++) {
    const cameraX = 2 * x / w - 1;
    const rayDirX = dirX + planeX * cameraX;
    const rayDirY = dirY + planeY * cameraX;

    let mapX = Math.floor(posX);
    let mapY = Math.floor(posY);

    let sideDistX, sideDistY;

    const deltaDistX = Math.abs(1 / rayDirX);
    const deltaDistY = Math.abs(1 / rayDirY);

    let stepX, stepY;

    let hit = 0;
    let side;

    if(rayDirX < 0) {
      stepX = -1;
      sideDistX = (posX - mapX) * deltaDistX;
    } else {
      stepX = 1;
      sideDistX = (mapX + 1.0 - posX) * deltaDistX;
    }
    if(rayDirY < 0) {
      stepY = -1;
      sideDistY = (posY - mapY) * deltaDistY;
    } else {
      stepY = 1;
      sideDistY = (mapY + 1.0 - posY) * deltaDistY;
    }

    while(hit === 0) {
      if(sideDistX < sideDistY) {
        sideDistX += deltaDistX;
        mapX += stepX;
        side = 0;
      } else {
        sideDistY += deltaDistY;
        mapY += stepY;
        side = 1;
      }
      if(map[mapX] && map[mapX][mapY] > 0) hit = 1;
    }

    let perpWallDist;
    if(side === 0) perpWallDist = (mapX - posX + (1 - stepX) / 2) / rayDirX;
    else perpWallDist = (mapY - posY + (1 - stepY) / 2) / rayDirY;

    // Wall height on screen
    let lineHeight = Math.floor(h / perpWallDist);

    // Draw walls or doors
    const tile = map[mapX][mapY];
    if(tile === 1) {
      ctx.fillStyle = side === 1 ? "#888" : "#BBB";
      ctx.fillRect(x, (h - lineHeight) / 2, 1, lineHeight);
    } else if(tile === 2) {
      // Door - draw double width (two vertical stripes)
      ctx.fillStyle = side === 1 ? "#553311" : "#774422";
      ctx.fillRect(x, (h - lineHeight) / 2, 1, lineHeight);
      if(x + 1 < w) ctx.fillRect(x + 1, (h - lineHeight) / 2, 1, lineHeight);
    }
  }
}

// Draw items as small 3D "floor cubes" on ground
function drawItems() {
  items.forEach(item => {
    const spriteX = item.x - posX;
    const spriteY = item.y - posY;

    const invDet = 1 / (planeX * dirY - dirX * planeY);

    const transformX = invDet * (dirY * spriteX - dirX * spriteY);
    const transformY = invDet * (-planeY * spriteX + planeX * spriteY);

    if(transformY <= 0) return; // Behind player - skip

    const spriteScreenX = Math.floor((w / 2) * (1 + transformX / transformY));

    // Distance based size
    const baseSize = h / transformY;

    // We want a small cube on the floor:
    // Cube size smaller than wall slice height
    const cubeHeight = baseSize / 8;
    const cubeWidth = cubeHeight;

    // Calculate vertical offset so cube sits on floor (bottom of screen)
    // The floor line is at h/2, wall bottom is at (h + lineHeight)/2 for walls
    // We'll put the cube so its bottom is slightly above the bottom of canvas
    const floorPosY = h / 1.05; // near bottom of screen (~95%)
    const drawStartY = floorPosY - cubeHeight;
    const drawEndY = floorPosY;

    // Horizontal position centered at spriteScreenX
    const drawStartX = spriteScreenX - cubeWidth / 2;
    const drawEndX = spriteScreenX + cubeWidth / 2;

    // Draw cube base (floor part)
    ctx.fillStyle = "#FFD700"; // gold color
    ctx.fillRect(drawStartX, drawStartY, cubeWidth, cubeHeight);

    // Draw "3D" sides for cube
    // Left side (darker)
    ctx.fillStyle = "#B8860B";
    ctx.beginPath();
    ctx.moveTo(drawStartX, drawEndY);
    ctx.lineTo(drawStartX, drawStartY);
    ctx.lineTo(drawStartX - cubeWidth / 4, drawStartY - cubeHeight / 2);
    ctx.lineTo(drawStartX - cubeWidth / 4, drawEndY - cubeHeight / 2);
    ctx.closePath();
    ctx.fill();

    // Top side (lighter)
    ctx.fillStyle = "#FFEC8B";
    ctx.beginPath();
    ctx.moveTo(drawStartX, drawStartY);
    ctx.lineTo(drawStartX + cubeWidth, drawStartY);
    ctx.lineTo(drawStartX + cubeWidth - cubeWidth / 4, drawStartY - cubeHeight / 2);
    ctx.lineTo(drawStartX - cubeWidth / 4, drawStartY - cubeHeight / 2);
    ctx.closePath();
    ctx.fill();

    // Draw item name above cube
    ctx.fillStyle = "white";
    ctx.font = "12px monospace";
    ctx.textAlign = "center";
    ctx.fillText(item.name, spriteScreenX, drawStartY - cubeHeight - 5);
  });
}

function render() {
  // Clear screen
  ctx.clearRect(0, 0, w, h);

  // Ceiling
  ctx.fillStyle = "#333";
  ctx.fillRect(0, 0, w, h / 2);

  // Floor
  ctx.fillStyle = "#777";
  ctx.fillRect(0, h / 2, w, h / 2);

  castRays();

  drawItems();
}

function gameLoop() {
  update();
  render();
  requestAnimationFrame(gameLoop);
}

gameLoop();
</script>
</body>
</html>
