<!DOCTYPE html>
<html>
<head>
  <title>Raycasting with Varying Heights</title>
  <style>
    body { margin: 0; overflow: hidden; background: black; }
    canvas { display: block; }
  </style>
</head>
<body>
<canvas id="gameCanvas" width="800" height="600"></canvas>
<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const WIDTH = canvas.width;
const HEIGHT = canvas.height;

// Simple map with varying heights (0 = empty, 1-5 = wall height)
const map = [
  [3,3,3,3,3,3,3,3],
  [3,0,0,0,0,0,0,3],
  [3,0,1,0,2,0,0,3],
  [3,0,0,5,0,0,0,3],
  [3,0,2,0,4,0,0,3],
  [3,0,0,0,0,0,0,3],
  [3,3,3,3,3,3,3,3],
];
const mapW = map[0].length;
const mapH = map.length;

// Player position
let posX = 3.5;
let posY = 3.5;
let dir = Math.PI / 4; // Facing 45 degrees

// Movement
let keys = {};
document.addEventListener("keydown", e => keys[e.key] = true);
document.addEventListener("keyup", e => keys[e.key] = false);

function castRays() {
  const fov = Math.PI / 3;
  const numRays = WIDTH;
  const angleStep = fov / numRays;

  for (let i = 0; i < numRays; i++) {
    const rayAngle = dir - fov / 2 + i * angleStep;
    let rayX = posX;
    let rayY = posY;

    const stepSize = 0.01;
    let hit = false;
    let dist = 0;
    let height = 0;

    while (!hit && dist < 20) {
      rayX += Math.cos(rayAngle) * stepSize;
      rayY += Math.sin(rayAngle) * stepSize;
      dist += stepSize;

      const mx = Math.floor(rayX);
      const my = Math.floor(rayY);

      if (mx >= 0 && mx < mapW && my >= 0 && my < mapH) {
        height = map[my][mx];
        if (height > 0) hit = true;
      } else {
        hit = true;
        height = 0;
      }
    }

    // Fix fisheye effect
    const correctedDist = dist * Math.cos(rayAngle - dir);

    const wallHeight = (HEIGHT / correctedDist) * (height / 3);
    const y1 = HEIGHT / 2 - wallHeight;
    const y2 = HEIGHT / 2 + wallHeight;

    const shade = 50 + height * 40;
    ctx.fillStyle = `rgb(${shade},${shade},${shade})`;
    ctx.fillRect(i, y1, 1, y2 - y1);
  }
}

function movePlayer() {
  const speed = 0.05;
  if (keys['w']) {
    const nx = posX + Math.cos(dir) * speed;
    const ny = posY + Math.sin(dir) * speed;
    if (map[Math.floor(ny)][Math.floor(nx)] === 0) {
      posX = nx;
      posY = ny;
    }
  }
  if (keys['s']) {
    const nx = posX - Math.cos(dir) * speed;
    const ny = posY - Math.sin(dir) * speed;
    if (map[Math.floor(ny)][Math.floor(nx)] === 0) {
      posX = nx;
      posY = ny;
    }
  }
  if (keys['a']) dir -= 0.03;
  if (keys['d']) dir += 0.03;
}

function loop() {
  movePlayer();
  ctx.fillStyle = "#333";
  ctx.fillRect(0, 0, WIDTH, HEIGHT / 2); // Sky
  ctx.fillStyle = "#222";
  ctx.fillRect(0, HEIGHT / 2, WIDTH, HEIGHT / 2); // Ground
  castRays();
  requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>
