<!DOCTYPE html>
<html>
<head>
  <title>Raycasting Terrain</title>
  <style>
    body { margin:0; overflow:hidden; background:#000; }
    canvas { display:block; }
  </style>
</head>
<body>
<canvas id="game"></canvas>
<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resize();
window.addEventListener("resize", resize);

// Map: numbers define wall height (0 = no wall)
const map = [
  [3,3,3,3,3,3,3,3],
  [3,0,0,0,2,0,0,3],
  [3,0,1,0,2,0,0,3],
  [3,0,0,4,0,0,0,3],
  [3,0,2,0,5,0,0,3],
  [3,0,0,0,2,0,0,3],
  [3,3,3,3,3,3,3,3]
];
const mapW = map[0].length, mapH = map.length;

// Player
let posX = 4.5, posY = 4.5;
let dirX = -1, dirY = 0;
let planeX = 0, planeY = 0.66; // camera plane

let keys = {};
document.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
document.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

// Mouse look
let mouseLocked = false;
canvas.onclick = () => {
  canvas.requestPointerLock();
};
document.addEventListener('pointerlockchange', () => {
  mouseLocked = document.pointerLockElement === canvas;
});
document.addEventListener('mousemove', e => {
  if (!mouseLocked) return;
  const rot = -e.movementX * 0.002;
  const oldX = dirX;
  dirX = dirX * Math.cos(rot) - dirY * Math.sin(rot);
  dirY = oldX * Math.sin(rot) + dirY * Math.cos(rot);
  const oldPX = planeX;
  planeX = planeX * Math.cos(rot) - planeY * Math.sin(rot);
  planeY = oldPX * Math.sin(rot) + planeY * Math.cos(rot);
});

function gameLoop() {
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);

  // Draw sky/ground
  ctx.fillStyle = "#444"; ctx.fillRect(0, 0, W, H/2);
  ctx.fillStyle = "#222"; ctx.fillRect(0, H/2, W, H/2);

  // Raycast per screen column
  for (let x = 0; x < W; x++) {
    const cameraX = 2 * x / W - 1;
    const rayDirX = dirX + planeX * cameraX;
    const rayDirY = dirY + planeY * cameraX;

    let mapX = Math.floor(posX), mapY = Math.floor(posY);
    let sideDistX, sideDistY, deltaDistX, deltaDistY;
    let stepX, stepY, hit = false, side = 0;
    deltaDistX = Math.abs(1 / rayDirX);
    deltaDistY = Math.abs(1 / rayDirY);

    if (rayDirX < 0) {
      stepX = -1;
      sideDistX = (posX - mapX) * deltaDistX;
    } else {
      stepX = 1;
      sideDistX = (mapX + 1 - posX) * deltaDistX;
    }
    if (rayDirY < 0) {
      stepY = -1;
      sideDistY = (posY - mapY) * deltaDistY;
    } else {
      stepY = 1;
      sideDistY = (mapY + 1 - posY) * deltaDistY;
    }

    // Walking through the grid
    let wallHeight = 0;
    let perpDist = 0;
    while (!hit) {
      if (sideDistX < sideDistY) {
        sideDistX += deltaDistX;
        mapX += stepX;
        side = 0;
      } else {
        sideDistY += deltaDistY;
        mapY += stepY;
        side = 1;
      }
      if (mapX >= 0 && mapY >= 0 && mapX < mapW && mapY < mapH) {
        wallHeight = map[mapY][mapX];
        if (wallHeight > 0) hit = true;
      } else {
        hit = true;
        wallHeight = 1;
      }
    }

    perpDist = side === 0
      ? (mapX - posX + (1 - stepX) / 2) / rayDirX
      : (mapY - posY + (1 - stepY) / 2) / rayDirY;

    const lineH = Math.floor(H / perpDist * wallHeight);
    let y0 = Math.floor(H/2 - lineH/2);
    let y1 = y0 + lineH;

    // Shade by height and side
    const brightness = side ? 0.6 : 1;
    const shade = Math.min(255, 80 * wallHeight);
    ctx.strokeStyle = `rgba(${shade},${shade},${shade},${brightness})`;
    ctx.beginPath();
    ctx.moveTo(x, y0);
    ctx.lineTo(x, y1);
    ctx.stroke();
  }

  // Movement
  const moveSpeed = 0.05;
  if (keys['w']) {
    const nx = posX + dirX * moveSpeed;
    const ny = posY + dirY * moveSpeed;
    if (map[Math.floor(ny)][Math.floor(nx)] === 0) {
      posX = nx; posY = ny;
    }
  }
  if (keys['s']) {
    const nx = posX - dirX * moveSpeed;
    const ny = posY - dirY * moveSpeed;
    if (map[Math.floor(ny)][Math.floor(nx)] === 0) {
      posX = nx; posY = ny;
    }
  }
  if (keys['a'] || keys['d']) {
    const side = keys['a'] ? 1 : -1;
    // strafing
    const nx = posX + dirY * moveSpeed * side;
    const ny = posY - dirX * moveSpeed * side;
    if (map[Math.floor(ny)][Math.floor(nx)] === 0) {
      posX = nx; posY = ny;
    }
  }

  requestAnimationFrame(gameLoop);
}
gameLoop();
</script>
</body>
</html>
